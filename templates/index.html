{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentimen Analysis</title>
    <link rel="stylesheet" href="{% static "vendor/css/bootstrap.min.css" %}">
    <link rel="stylesheet" href="{% static "vendor/jquery-loading/demo.css" %}">

</head>
<body>
    <h3 class="text-center mt-3">Sentimen Analysis</h3>
    <div class="container mt-5 justify-content-center"  align="center">      
        <div class="row justify-content-center">      
            <div class="col-md-3" id="loading-data1">
                <select class="custom-select" id="data1" name="data1">
                    <option selected>Pilih menu</option>
                    <option value="Oyo">Oyo</option>
                    <option value="Traveloka">Traveloka</option>
                    <option value="Booking.com">Booking.com</option>
                    <option value="Tiket.com">Tiket.com</option>
                    <option value="Airy">Airy</option>
                    <option value="Mister Aladin">Mister Aladin</option>
                    <option value="PegiPegi">Pegipegi</option>
                    <option value="RedDoorz">RedDoorz</option>
                    <option value="Agoda">Agoda</option>
                    <option value="Trivago">Trivago</option>
                </select>              
               
                <img src="{% static "images/oyo.png" %}" class="mt-3 mb-3" width="100%" height="40%" alt="My image" id="logo1">
                <div id="chart1">
                    <canvas id="myChart1" style="height:auto; width:70%;"></canvas>
                    <h4 id="akurasi1"></h4>
                </div>

            </div>
           
            <div class="col-md-2 text-center">
                <h4>Bandingkan</h4>
                
            </div>
            <div class="col-md-3" id="loading-data2">
                <select class="custom-select" id="data2" name="data2">
                    <option selected>Pilih menu</option>
                    <option value="Oyo">Oyo</option>
                    <option value="Traveloka">Traveloka</option>
                    <option value="Booking.com">Booking.com</option>
                    <option value="Tiket.com">Tiket.com</option>
                    <option value="Airy">Airy</option>
                    <option value="Mister Aladin">Mister Aladin</option>
                    <option value="Pegi-Pegi">Pegi-Pegi</option>
                    <option value="RedDoorz">RedDoorz</option>
                    <option value="Agoda">Agoda</option>
                    <option value="Trivago">Trivago</option>
                </select>

                <img src="{% static "images/oyo.png" %}" class="mt-3 mb-3" width="100%" height="40%" alt="My image" id="logo2">
                <div id="chart2" style="display: none;">
                    <canvas id="myChart2" style="height:auto; width:70%;"></canvas>
                    <h4 id="akurasi2"></h4>
                </div>
             

            </div>
       
        </div>
    
    </div>

<script src="{% static "vendor/js/jquery-3.2.1.slim.min.js" %}"></script>
<script src= "{% static "vendor/js/bootstrap.min.js" %}" ></script>
<script src="{% static "vendor/js/chart.js" %}"></script>
<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/randomcolor/0.4.2/randomColor.min.js"></script>
<script src="{% static "vendor/jquery-loading/dist/jquery.loading.js" %}"></script>

<script> 
  
    var positif1 = []
    var negatif1 = []
    var positif2 = []
    var negatif2 = []
    var ctx1 = document.getElementById('myChart1').getContext('2d');
    var ctx2 = document.getElementById('myChart2').getContext('2d');
    $.ajaxSetup({
        data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
    });

    $("#data1").change(function() {
        let value = $(this).val()
        let dir = "{% static 'images/' %}" + `${value}.png`
        $('#loading-data1').loading();
        $("#data2").attr("disabled", "true")
        $.ajax({
            type: "POST",
            dataType: "JSON",
            url: "{% url 'store' %}",           
            data: {
                value: value
            },
            success: function(data) {        
                console.log(data)
                $("#data2").removeAttr("disabled")
              let length = Object.keys(data.label).length
              for(i=0;i<length;i++){
                if(data.label[i] == 1){
                    positif1.push(data.label[i])               
                }else{
                    negatif1.push(data.label[i]) 
                }
                  
              }

                $("#loading-data1").loading('stop')
                $("#logo1").attr("src", dir)
                donnutChart1(positif1.length, negatif1.length);
               
                $("#chart1").css("display", "")               
                $("#akurasi1").html("Akurasi : " + data.akurasi[0] + "%")
            },
            error: function(data) {
                $("#loading-data1").loading('stop')
                alert("gagal scrapping");
                $("#data2").removeAttr("disabled")
                console.log(data)
            }
        })
    })

    $("#data2").change(function() {
        let value = $(this).val()
        console.log(value)
        let dir = "{% static 'images/' %}" + `${value}.png`
        $('#loading-data2').loading();
        $("#data1").attr("disabled", "true")
        $.ajax({
            type: "POST",
            url: "{% url 'store' %}",           
            data: {
                value: value                
            },
            success: function(data) {                
                $("#loading-data2").loading('stop')
                $("#logo2").attr("src", dir)
                $("#data2").removeAttr("disabled")
                let length = Object.keys(data.label).length
                    for(i=0;i<length;i++){
                        if(data.label[i] == 1){
                            positif2.push(data.label[i])               
                        }else{
                            negatif2.push(data.label[i]) 
                        }
                    }

                $("#chart2").css("display", "")               
                donnutChart2(positif2.length, negatif2.length);
                $("#akurasi2").html("Akurasi " + data.akurasi[0] + "%")

            },
            error: function(data) {
                $("#loading-data2").loading('stop')
                alert("gagal scrapping");
                $("#data1").removeAttr("disabled")
                console.log(data)
            }
        })
    })

    function donnutChart1(positif, negatif)
    {
        data = {
        datasets: [{
            data: [positif, negatif],
            backgroundColor: [
                    'rgb(61, 145, 204)', //positif biru          
                    'rgb(230, 18, 7)', //merah negatif                 
                ],
            
            borderColor: [
                
                'rgb(61, 145, 204)',
                'rgb(230, 18, 7)'
            ]
        }],

        // These labels appear in the legend and in the tooltips when hovering different arcs
        labels: [
            'Positif',
            'Negatif',
            
            ]
        };

        Chart.pluginService.register({
            beforeDraw: function (chart) {
                if (chart.config.options.elements.center) {
            //Get ctx from string
            var ctx = chart.chart.ctx;
            
                    //Get options from the center object in options
            var centerConfig = chart.config.options.elements.center;
            var fontStyle = centerConfig.fontStyle || 'Arial';
                    var txt = centerConfig.text;
            var color = centerConfig.color || '#000';
            var sidePadding = centerConfig.sidePadding || 20;
            var sidePaddingCalculated = (sidePadding/100) * (chart.innerRadius * 2)
            //Start with a base font of 30px
            ctx.font = "30px " + fontStyle;
            
                    //Get the width of the string and also the width of the element minus 10 to give it 5px side padding
            var stringWidth = ctx.measureText(txt).width;
            var elementWidth = (chart.innerRadius * 2) - sidePaddingCalculated;

            // Find out how much the font can grow in width.
            var widthRatio = elementWidth / stringWidth;
            var newFontSize = Math.floor(30 * widthRatio);
            var elementHeight = (chart.innerRadius * 2);

            // Pick a new font size so it will not be larger than the height of label.
            var fontSizeToUse = Math.min(newFontSize, elementHeight);

                    //Set font settings to draw it correctly.
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            var centerX = ((chart.chartArea.left + chart.chartArea.right) / 2);
            var centerY = ((chart.chartArea.top + chart.chartArea.bottom) / 2);
            ctx.font = fontSizeToUse+"px " + fontStyle;
            ctx.fillStyle = color;
            
            //Draw text in center
            ctx.fillText(txt, centerX, centerY);
                }
            }
        });


        var myDoughnutChart = new Chart(ctx1, {
            type: 'doughnut',
            data: data,
            options: {
                elements: {
                    center: {
                    text: positif,
                    color: '#36A2EB', //Default black
                    fontStyle: 'Helvetica', //Default Arial
                    sidePadding: 15 //Default 20 (as a percentage)
                    }
                }
            }
        });
    }


    function donnutChart2(positif, negatif)
    {
        data = {
        datasets: [{
            data: [positif, negatif],
            backgroundColor: [
                    'rgb(61, 145, 204)', //positif biru          
                    'rgb(230, 18, 7)', //merah negatif                 
                ],
            
            borderColor: [
                
                'rgb(61, 145, 204)',
                'rgb(230, 18, 7)'
            ]
        }],

        // These labels appear in the legend and in the tooltips when hovering different arcs
        labels: [
            'Positif',
            'Negatif',
            
            ]
        };

        Chart.pluginService.register({
            beforeDraw: function (chart) {
                if (chart.config.options.elements.center) {
            //Get ctx from string
            var ctx = chart.chart.ctx;
            
                    //Get options from the center object in options
            var centerConfig = chart.config.options.elements.center;
            var fontStyle = centerConfig.fontStyle || 'Arial';
                    var txt = centerConfig.text;
            var color = centerConfig.color || '#000';
            var sidePadding = centerConfig.sidePadding || 20;
            var sidePaddingCalculated = (sidePadding/100) * (chart.innerRadius * 2)
            //Start with a base font of 30px
            ctx.font = "30px " + fontStyle;
            
                    //Get the width of the string and also the width of the element minus 10 to give it 5px side padding
            var stringWidth = ctx.measureText(txt).width;
            var elementWidth = (chart.innerRadius * 2) - sidePaddingCalculated;

            // Find out how much the font can grow in width.
            var widthRatio = elementWidth / stringWidth;
            var newFontSize = Math.floor(30 * widthRatio);
            var elementHeight = (chart.innerRadius * 2);

            // Pick a new font size so it will not be larger than the height of label.
            var fontSizeToUse = Math.min(newFontSize, elementHeight);

                    //Set font settings to draw it correctly.
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            var centerX = ((chart.chartArea.left + chart.chartArea.right) / 2);
            var centerY = ((chart.chartArea.top + chart.chartArea.bottom) / 2);
            ctx.font = fontSizeToUse+"px " + fontStyle;
            ctx.fillStyle = color;
            
            //Draw text in center
            ctx.fillText(txt, centerX, centerY);
                }
            }
        });


        var myDoughnutChart = new Chart(ctx2, {
            type: 'doughnut',
            data: data,
            options: {
                elements: {
                    center: {
                    text: positif,
                    color: '#36A2EB', //Default black
                    fontStyle: 'Helvetica', //Default Arial
                    sidePadding: 15 //Default 20 (as a percentage)
                    }
                }
            }
        });
    }

</script>

</body>
</html>